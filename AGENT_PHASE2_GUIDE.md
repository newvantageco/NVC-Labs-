# Autonomous Agent - Phase 2: Auto-Fix & Deployment

**Complete autonomous system that detects, diagnoses, fixes, and deploys code changes automatically.**

---

## üéØ What's New in Phase 2

Phase 1 gave you **monitoring and detection**.
Phase 2 adds **autonomous fixing and deployment**:

‚úÖ **AI-Powered Diagnosis** - Claude API analyzes errors and finds root causes
‚úÖ **Auto-Code Generation** - Claude generates fixes for detected issues
‚úÖ **Git Integration** - Creates branches, commits fixes automatically
‚úÖ **Staging Pipeline** - Deploys to staging first, tests before production
‚úÖ **Auto-Rollback** - Reverts if errors detected after deployment
‚úÖ **Human Approval** - Optional approval workflow for critical issues

---

## üèóÔ∏è System Architecture

```
Detection ‚Üí Diagnosis ‚Üí Fix ‚Üí Staging ‚Üí Monitor ‚Üí Production
    ‚Üì          ‚Üì         ‚Üì        ‚Üì         ‚Üì          ‚Üì
  Issue     Root Cause  Code    Test     Health    Deploy
  Found     Identified  Fixed   Pass     Check     Success
                                           ‚Üì
                                        Rollback
                                        (if fail)
```

---

## üìã Prerequisites

**Required:**
- ‚úÖ Phase 1 deployed and operational
- ‚úÖ Database migration `005_agent_system.sql` applied
- ‚úÖ Anthropic API key (Claude API)
- ‚úÖ Git repository initialized with `main` and `staging` branches

**Optional but Recommended:**
- ‚≠ê Slack webhook for notifications
- ‚≠ê Automated tests configured (`npm test`)
- ‚≠ê CI/CD pipeline on Vercel

---

## üöÄ Quick Start

### **Step 1: Add Anthropic API Key**

1. Go to https://console.anthropic.com
2. Create API key
3. Add to Vercel environment variables:

```bash
ANTHROPIC_API_KEY=sk-ant-api03-your-key-here
```

4. Redeploy

---

### **Step 2: Install Dependencies**

```bash
npm install @anthropic-ai/sdk
```

Or just redeploy - Vercel will install automatically.

---

### **Step 3: Set Up Git Branches**

```bash
# Create staging branch if it doesn't exist
git checkout -b staging
git push origin staging

# Switch back to main
git checkout main
```

---

### **Step 4: Configure Agent Settings**

Go to `/dashboard/agent` and:

1. Set **Autonomy Level 2** (Auto-Fix Low Risk)
2. Verify agent is Active
3. Check that ANTHROPIC_API_KEY is set (error will show if missing)

---

### **Step 5: Test The System**

**Option A: Wait for Natural Issues**
- Agent will detect issues during normal operation
- Check `/dashboard/agent` for detected problems

**Option B: Simulate an Issue** (Testing)
```sql
-- Insert a test issue
INSERT INTO agent_issues (
  severity,
  issue_type,
  title,
  message,
  affected_users,
  status
) VALUES (
  'P2',
  'api_error',
  'Test issue for agent',
  'POST /api/test returning 500',
  1,
  'detected'
);
```

Then watch the agent:
1. Diagnose the issue
2. Generate a fix
3. Create git branch
4. Commit fix
5. Deploy to staging
6. (If Level 2+) Auto-promote to production

---

## ü§ñ How Auto-Fix Works

### **1. Detection (Every 5 Minutes)**

Cron job runs ‚Üí Detects issue ‚Üí Logs to database

### **2. Diagnosis (AI-Powered)**

```typescript
// Agent reads error
Error: "Cannot read property 'id' of undefined"
Location: src/app/api/campaigns/launch/route.ts:42

// Claude analyzes
Root Cause: "Missing null check on database query result"

// Claude proposes fix
Fix Strategy: "Add null check after supabase query before accessing practice.id"

// Confidence: 95%
// Requires approval: No (P2 issue, Level 2 autonomy)
```

### **3. Fix Generation (AI-Powered)**

Claude API generates complete fixed code:

**Before:**
```typescript
const { data: practice } = await supabase
  .from('practices')
  .select('id')
  .eq('user_id', user.id)
  .single()

const practiceId = practice.id // ‚ùå Crash if practice is null
```

**After (Generated by Claude):**
```typescript
const { data: practice, error } = await supabase
  .from('practices')
  .select('id')
  .eq('user_id', user.id)
  .single()

if (error || !practice) {
  return NextResponse.json(
    { error: 'Practice not found' },
    { status: 404 }
  )
}

const practiceId = practice.id // ‚úÖ Safe
```

### **4. Git Workflow**

```bash
# Agent creates branch
git checkout -b agent/fix-abc123

# Applies fix
# (Writes fixed code to file)

# Commits
git add .
git commit -m "Fix: Missing null check for practice query..."

# Pushes to staging
git checkout staging
git merge agent/fix-abc123
git push origin staging
```

### **5. Staging Deployment**

- Vercel detects `staging` branch push
- Deploys to `staging.nvclabs.com` (or preview URL)
- Agent monitors for 10 minutes
- Checks health endpoint every minute
- If errors detected ‚Üí Stops (requires human review)
- If healthy ‚Üí Continues to production

### **6. Production Deployment**

**If Autonomy Level 2+:**
```bash
# Agent promotes to production
git checkout main
git merge staging
git push origin main

# Vercel deploys to production
# Agent monitors for 30 minutes
# If errors increase >20% ‚Üí ROLLBACK
```

**If Autonomy Level 1:**
- Agent stops at staging
- Sends Slack notification
- Human reviews `/dashboard/agent`
- Human clicks "Approve & Deploy"
- Then proceeds to production

### **7. Rollback (If Needed)**

```bash
# If errors detected after production deploy
git checkout main
git reset --hard HEAD~1
git push origin main --force

# Vercel redeploys previous version
```

---

## üõ°Ô∏è Safety Mechanisms

### **Protected Files**

Agent CANNOT modify these files:

```
- supabase/migrations/*.sql
- src/app/api/billing/**
- src/app/api/webhooks/stripe/**
- .env*
- vercel.json
- package.json (requires approval)
```

If agent attempts to modify protected file ‚Üí **Fix rejected automatically**

### **Confidence Threshold**

- If AI confidence < 80% ‚Üí **Human approval required**
- If AI says "requires human approval" ‚Üí **Human approval required**
- If estimated fix time > 30 minutes ‚Üí **Human approval required**

### **Severity-Based Approval**

| Autonomy Level | P0 (Critical) | P1 (High) | P2 (Medium) | P3-P4 (Low) |
|----------------|---------------|-----------|-------------|-------------|
| **Level 1** | Manual | Manual | Manual | Manual |
| **Level 2** | Manual | Manual | Auto | Auto |
| **Level 3** | Manual* | Auto | Auto | Auto |

*Level 3 only requires approval for P0 if human approval explicitly recommended

### **Rate Limits**

- Max 10 deployments per day
- Max 5 fixes per hour
- If limits hit ‚Üí Agent pauses, sends alert

### **Health Monitoring**

**Staging (10 minutes):**
- Health check every 1 minute
- If 3 consecutive failures ‚Üí Abort
- If any new errors ‚Üí Abort

**Production (30 minutes):**
- Health check every 5 minutes
- If error rate increases >50% ‚Üí Rollback
- If 2 consecutive health failures ‚Üí Rollback

---

## üìä Agent Dashboard

### **New Features in Phase 2:**

1. **Pending Approvals Section**
   - Shows fixes awaiting human review
   - Displays AI confidence, root cause, fix strategy
   - "Approve & Deploy" or "Reject Fix" buttons

2. **Fix History**
   - All auto-fixes applied
   - Success rate
   - Average fix time
   - Rollback count

3. **Real-Time Status**
   - Currently diagnosing
   - Currently fixing
   - Currently deploying
   - Live progress indicators

---

## üîî Notifications

### **Slack Messages You'll Receive:**

**Issue Detected:**
```
üö® P1: High AI call failure rate
Message: 15 calls failed in last 5 minutes
Affected Users: 3 practices
[View in Dashboard]
```

**Fix Awaiting Approval (Level 1 or P0/P1):**
```
ü§ñ Fix Ready for Approval
Issue: High AI call failure rate
Root Cause: Bland AI API key expired
Fix Strategy: Update API key validation and error handling
Confidence: 95%
[Review & Approve]
```

**Fix Deployed Successfully:**
```
‚úÖ Issue Resolved: High AI call failure rate
Root Cause: Bland AI API key expired
Status: Deployed to Production
[View Details]
```

**Rollback Triggered:**
```
‚ö†Ô∏è Rollback Executed
Issue: Fix caused new errors
Action: Reverted to previous version
Status: Manual review required
[View Issue]
```

---

## üß™ Testing The System

### **Test Scenario 1: Simple Bug Fix (P3)**

1. Create test issue:
```sql
INSERT INTO agent_issues (
  severity, issue_type, title, message, status
) VALUES (
  'P3', 'typo', 'Fix typo in error message', 'Spelling error in API response', 'detected'
);
```

2. Watch agent:
   - Diagnose (uses Claude API)
   - Fix (generates corrected code)
   - Commit (creates branch, pushes)
   - Deploy to staging (Vercel deploys)
   - Monitor staging (10 minutes)
   - Deploy to production (auto-merges)
   - Monitor production (30 minutes)

3. Check dashboard:
   - Issue status: resolved
   - Commit SHA visible
   - Branch name shown

### **Test Scenario 2: Critical Bug (P0)**

1. Create P0 issue:
```sql
INSERT INTO agent_issues (
  severity, issue_type, title, message, affected_users, status
) VALUES (
  'P0', 'database_error', 'Database connection failing', 'All users affected', -1, 'detected'
);
```

2. Watch agent:
   - Diagnose
   - Fix
   - Stops at staging
   - Sends Slack "Approval Required"

3. Human reviews dashboard:
   - Sees pending approval
   - Reviews root cause & fix
   - Clicks "Approve & Deploy"

4. Agent continues:
   - Deploys to production
   - Monitors carefully
   - Success!

---

## üîß Troubleshooting

### **Agent Stuck on "Diagnosing"**

**Cause:** ANTHROPIC_API_KEY missing or invalid

**Fix:**
1. Check Vercel environment variables
2. Ensure `ANTHROPIC_API_KEY` starts with `sk-ant-`
3. Test API key: https://console.anthropic.com
4. Redeploy

---

### **Fix Generation Failed**

**Possible Causes:**
- Protected file attempted modification
- AI couldn't generate valid fix
- File not found

**Fix:**
- Check agent_actions table for error details
- Review issue manually
- May require human intervention

---

### **Staging Deployment Failed**

**Cause:** Git conflicts, branch issues

**Fix:**
```bash
# Reset staging branch
git checkout staging
git reset --hard main
git push origin staging --force

# Agent will retry
```

---

### **Tests Failing**

**Cause:** Generated fix breaks tests

**Fix:**
- Agent automatically stops if tests fail
- No deployment happens
- Human reviews and fixes manually
- Mark issue as resolved manually

---

### **Production Rollback Triggered**

**Cause:** Errors increased after deployment

**Fix:**
- Automatic rollback already happened
- Previous version restored
- Issue marked as "failed"
- Human investigates root cause
- Apply better fix manually

---

## üí∞ Cost Analysis

### **Phase 2 Operating Costs:**

**Claude API Usage:**
- Detection: 1000 calls/month √ó $0.001 = $1/month (Haiku)
- Diagnosis: 50 issues/month √ó $0.50 = $25/month (Sonnet)
- Fix Generation: 50 fixes/month √ó $0.75 = $37.50/month (Sonnet)
- **Total Claude API: ~$63.50/month**

**Other Costs:**
- Vercel Cron: Free
- Database: +$3/month (agent logs)
- **Total: ~$66.50/month**

**ROI:**
- Saves 20-30 hours/month of manual debugging
- Faster issue resolution (minutes vs hours)
- Less downtime
- Better user experience
- **Value: $1000-2000/month**

---

## üìà Success Metrics (After 30 Days)

**Target Goals:**
- ‚úÖ 80%+ of P2-P4 issues fixed automatically
- ‚úÖ <10 minute median time to fix
- ‚úÖ 95%+ fix success rate (no rollbacks)
- ‚úÖ <1% false positive rate
- ‚úÖ Zero failed auto-deployments

**How to Measure:**
```sql
-- Total issues detected
SELECT COUNT(*) FROM agent_issues;

-- Auto-fixed (no human intervention)
SELECT COUNT(*) FROM agent_issues WHERE status = 'resolved' AND deployed_at IS NOT NULL;

-- Success rate
SELECT
  COUNT(*) FILTER (WHERE status = 'resolved') * 100.0 / COUNT(*) as success_rate
FROM agent_issues;

-- Median resolution time
SELECT percentile_cont(0.5) WITHIN GROUP (ORDER BY
  EXTRACT(EPOCH FROM (resolved_at - created_at)) / 60
) as median_minutes
FROM agent_issues WHERE status = 'resolved';
```

---

## üéì Best Practices

### **Week 1: Monitor Mode**
- Keep Autonomy Level 1
- Review every fix proposal
- Build confidence in AI diagnosis
- Adjust protected files if needed

### **Week 2-3: Semi-Autonomous**
- Upgrade to Level 2
- Let agent handle P2-P4
- Still review P0-P1
- Monitor false positives

### **Week 4+: Full Autonomy**
- Consider Level 3 if success rate >95%
- Agent handles most issues
- You receive notifications
- Weekly review of actions

---

## üîê Security Considerations

1. **Code Review** - All fixes logged to git (reviewable)
2. **Audit Trail** - Every action logged to database (immutable)
3. **Protected Files** - Critical files cannot be touched
4. **Rollback Ready** - One-click revert
5. **Human Override** - Pause button stops everything
6. **API Key Security** - Anthropic key encrypted in Vercel

---

## üöÄ What's Next (Phase 3 - Future)

**Advanced Features:**
- **Performance Optimization Agent** - Auto-optimizes slow queries
- **Security Scanning Agent** - Detects vulnerabilities
- **Cost Optimization Agent** - Reduces API usage
- **Predictive Maintenance** - Prevents issues before they occur
- **Learning System** - Improves with each fix

---

## üìû Support

**Issues with Phase 2?**

1. Check `/dashboard/agent` for status
2. Review `agent_actions` table for errors
3. Test health endpoint: `curl https://your-domain.com/api/health`
4. Check Anthropic API key is valid
5. Review Vercel deployment logs

**Still stuck?**
- Email: support@nvclabs.com
- Include: Agent logs, error messages, issue IDs

---

**Last Updated:** March 2026
**Version:** 2.0.0
**Status:** Production Ready - Full Autonomy ‚úÖ
